<!DOCTYPE html>
<html lang="ko">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="utf-8" />
  <link rel="stylesheet" href="globals.css" />
  <link rel="stylesheet" href="styleguide.css" />
  <link rel="stylesheet" href="style.css" />
  <title>반려견 프로필 생성</title>

  <style>
    .preview-img {
      width: 100px;
      height: 100px;
      border-radius: 12px;
      object-fit: cover;
      display: none;
      margin-top: 8px;
    }
    .form-group {
      margin-bottom: 20px; /* ✅ 입력칸 간 여백 확보 */
    }
  </style>
</head>
<body>
  <main class="element-a-create-profile">
    <div class="div">
      <h1 class="text-wrapper-7">반려견 프로필 생성</h1>
      <form class="overlap-group" id="dogForm">

        <!-- ✅ 반려견 ID 입력칸 -->
        <div class="form-group">
          <label for="pet-id" class="text-wrapper-3">반려견 ID (영문/숫자)</label>
          <div class="div-wrapper">
            <input 
              type="text" 
              id="pet-id" 
              class="text-wrapper" 
              placeholder="dog123" 
              required
              oninput="this.value = this.value.replace(/[^A-Za-z0-9_]/g, '')" />
          </div>
        </div>

        <!-- ✅ 반려견 이름 -->
        <div class="form-group">
          <label for="pet-name" class="text-wrapper-4">반려견 이름</label>
          <div class="overlap-2">
            <input type="text" id="pet-name" class="text-wrapper" placeholder="쏘세지" required />
          </div>
        </div>

        <!-- ✅ 반려견 크기 -->
        <div class="form-group">
          <label for="pet-size" class="p">반려견 크기</label>
          <div class="overlap-3">
            <select id="pet-size" class="text-wrapper-2" required>
              <option value="소형견" selected>소형견</option>
              <option value="중형견">중형견</option>
              <option value="대형견">대형견</option>
            </select>
          </div>
        </div>

        <!-- ✅ 반려견 성별 -->
        <div class="form-group">
          <label for="pet-gender" class="text-wrapper-5">반려견 성별</label>
          <div class="overlap-4">
            <select id="pet-gender" class="text-wrapper-2">
              <option value="남" selected>남</option>
              <option value="여">여</option>
            </select>
          </div>
        </div>

        <!-- ✅ 프로필 사진 업로드 -->
        <div class="form-group">
          <label class="text-wrapper-6">프로필 사진</label>
          <div class="overlap" id="photo-button" role="button" tabindex="0">
            <img class="lens" src="lens.svg" alt="카메라 아이콘" />
          </div>
          <input type="file" id="pet-photo" accept="image/*" class="visually-hidden" />
          <img id="photo-preview" class="preview-img" />
        </div>

        <!-- ✅ 등록 버튼 -->
        <button type="submit" class="log-in-dark-mode">
          <span class="log-in">등록</span>
        </button>
      </form>
    </div>
  </main>

  <script>
  const photoButton = document.getElementById("photo-button");
  const photoInput = document.getElementById("pet-photo");
  const photoPreview = document.getElementById("photo-preview");
  const dogForm = document.getElementById("dogForm");

  // ✅ 클릭 시 파일 선택창 열기
  photoButton.addEventListener("click", () => photoInput.click());

  // ✅ 이미지 미리보기 + 저장
  photoInput.addEventListener("change", () => {
    const file = photoInput.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = e => {
        photoPreview.src = e.target.result;
        photoPreview.style.display = "block";
        localStorage.setItem("dog_photo", e.target.result);
      };
      reader.readAsDataURL(file);
    }
  });

  // ✅ 폼 제출 → localStorage 저장 후 서버에 보내기
  dogForm.addEventListener("submit", async e => {
    e.preventDefault();

    console.log("폼 이벤트 실행됨 ✅"); // 🔍 실행 여부 확인

    const petId = document.getElementById("pet-id").value;
    const petName = document.getElementById("pet-name").value;
    const petSize = document.getElementById("pet-size").value;
    const petGender = document.getElementById("pet-gender").value;

    console.log("입력값 ✅", { petId, petName, petSize, petGender }); // 🔍 값 확인

    // ✅ 한글 사이즈 → 영어 변환
    const sizeMap = {
      "소형견": "small",
      "중형견": "medium",
      "대형견": "large"
    };

    const petSizeEng = sizeMap[petSize] || "small"; // fallback

    // ✅ 로컬 저장
    localStorage.setItem("dog_key", petId);
    localStorage.setItem("dog_id", petName);
    localStorage.setItem("dog_size", petSize);
    localStorage.setItem("dog_gender", petGender);

    console.log("서버로 보낼 payload ✅", { dog_id: petId, size: petSizeEng });

    // ✅ 서버로 /activate_dog 전송
    try {
      const response = await fetch("http://192.168.137.1:8000/activate_dog", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          dog_id: petId,
          size: petSizeEng
        })
      });

      console.log("서버 응답 ✅", response);

      if (!response.ok) {
        throw new Error("서버 응답 오류");
      }

      alert("등록 완료! 홈 화면으로 이동합니다.");
      window.location.href = "../3_home/home.html";

    } catch (error) {
      console.error("서버 연결 실패 ❌", error);
      alert("서버 연결에 실패했습니다. 네트워크를 확인하세요!");
    }
  });
</script>


</body>
</html>
