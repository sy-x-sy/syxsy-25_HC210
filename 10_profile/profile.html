<!DOCTYPE html>
<html lang="ko">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="utf-8" />
  <link rel="stylesheet" href="globals.css" />
  <link rel="stylesheet" href="styleguide.css" />
  <link rel="stylesheet" href="style.css" />
  <title>ë°˜ë ¤ê²¬ í”„ë¡œí•„ ìƒì„±</title>

  <style>
    .preview-img {
      width: 100px;
      height: 100px;
      border-radius: 12px;
      object-fit: cover;
      display: none;
      margin-top: 8px;
    }
    .form-group {
      margin-bottom: 20px; /* âœ… ì…ë ¥ì¹¸ ê°„ ì—¬ë°± í™•ë³´ */
    }
  </style>
</head>
<body>
  <main class="element-a-create-profile">
    <div class="div">
      <h1 class="text-wrapper-7">ë°˜ë ¤ê²¬ í”„ë¡œí•„ ìƒì„±</h1>
      <form class="overlap-group" id="dogForm">

        <!-- âœ… ë°˜ë ¤ê²¬ ID ì…ë ¥ì¹¸ -->
        <div class="form-group">
          <label for="pet-id" class="text-wrapper-3">ë°˜ë ¤ê²¬ ID (ì˜ë¬¸/ìˆ«ì)</label>
          <div class="div-wrapper">
            <input 
              type="text" 
              id="pet-id" 
              class="text-wrapper" 
              placeholder="dog123" 
              required
              oninput="this.value = this.value.replace(/[^A-Za-z0-9_]/g, '')" />
          </div>
        </div>

        <!-- âœ… ë°˜ë ¤ê²¬ ì´ë¦„ -->
        <div class="form-group">
          <label for="pet-name" class="text-wrapper-4">ë°˜ë ¤ê²¬ ì´ë¦„</label>
          <div class="overlap-2">
            <input type="text" id="pet-name" class="text-wrapper" placeholder="ì˜ì„¸ì§€" required />
          </div>
        </div>

        <!-- âœ… ë°˜ë ¤ê²¬ í¬ê¸° -->
        <div class="form-group">
          <label for="pet-size" class="p">ë°˜ë ¤ê²¬ í¬ê¸°</label>
          <div class="overlap-3">
            <select id="pet-size" class="text-wrapper-2" required>
              <option value="ì†Œí˜•ê²¬" selected>ì†Œí˜•ê²¬</option>
              <option value="ì¤‘í˜•ê²¬">ì¤‘í˜•ê²¬</option>
              <option value="ëŒ€í˜•ê²¬">ëŒ€í˜•ê²¬</option>
            </select>
          </div>
        </div>

        <!-- âœ… ë°˜ë ¤ê²¬ ì„±ë³„ -->
        <div class="form-group">
          <label for="pet-gender" class="text-wrapper-5">ë°˜ë ¤ê²¬ ì„±ë³„</label>
          <div class="overlap-4">
            <select id="pet-gender" class="text-wrapper-2">
              <option value="ë‚¨" selected>ë‚¨</option>
              <option value="ì—¬">ì—¬</option>
            </select>
          </div>
        </div>

        <!-- âœ… í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ -->
        <div class="form-group">
          <label class="text-wrapper-6">í”„ë¡œí•„ ì‚¬ì§„</label>
          <div class="overlap" id="photo-button" role="button" tabindex="0">
            <img class="lens" src="lens.svg" alt="ì¹´ë©”ë¼ ì•„ì´ì½˜" />
          </div>
          <input type="file" id="pet-photo" accept="image/*" class="visually-hidden" />
          <img id="photo-preview" class="preview-img" />
        </div>

        <!-- âœ… ë“±ë¡ ë²„íŠ¼ -->
        <button type="submit" class="log-in-dark-mode">
          <span class="log-in">ë“±ë¡</span>
        </button>
      </form>
    </div>
  </main>

  <script>
  const photoButton = document.getElementById("photo-button");
  const photoInput = document.getElementById("pet-photo");
  const photoPreview = document.getElementById("photo-preview");
  const dogForm = document.getElementById("dogForm");

  // âœ… í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒì°½ ì—´ê¸°
  photoButton.addEventListener("click", () => photoInput.click());

  // âœ… ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° + ì €ì¥
  photoInput.addEventListener("change", () => {
    const file = photoInput.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = e => {
        photoPreview.src = e.target.result;
        photoPreview.style.display = "block";
        localStorage.setItem("dog_photo", e.target.result);
      };
      reader.readAsDataURL(file);
    }
  });

  // âœ… í¼ ì œì¶œ â†’ localStorage ì €ì¥ í›„ ì„œë²„ì— ë³´ë‚´ê¸°
  dogForm.addEventListener("submit", async e => {
    e.preventDefault();

    console.log("í¼ ì´ë²¤íŠ¸ ì‹¤í–‰ë¨ âœ…"); // ğŸ” ì‹¤í–‰ ì—¬ë¶€ í™•ì¸

    const petId = document.getElementById("pet-id").value;
    const petName = document.getElementById("pet-name").value;
    const petSize = document.getElementById("pet-size").value;
    const petGender = document.getElementById("pet-gender").value;

    console.log("ì…ë ¥ê°’ âœ…", { petId, petName, petSize, petGender }); // ğŸ” ê°’ í™•ì¸

    // âœ… í•œê¸€ ì‚¬ì´ì¦ˆ â†’ ì˜ì–´ ë³€í™˜
    const sizeMap = {
      "ì†Œí˜•ê²¬": "small",
      "ì¤‘í˜•ê²¬": "medium",
      "ëŒ€í˜•ê²¬": "large"
    };

    const petSizeEng = sizeMap[petSize] || "small"; // fallback

    // âœ… ë¡œì»¬ ì €ì¥
    localStorage.setItem("dog_key", petId);
    localStorage.setItem("dog_id", petName);
    localStorage.setItem("dog_size", petSize);
    localStorage.setItem("dog_gender", petGender);

    console.log("ì„œë²„ë¡œ ë³´ë‚¼ payload âœ…", { dog_id: petId, size: petSizeEng });

    // âœ… ì„œë²„ë¡œ /activate_dog ì „ì†¡
    try {
      const response = await fetch("http://192.168.137.1:8000/activate_dog", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          dog_id: petId,
          size: petSizeEng
        })
      });

      console.log("ì„œë²„ ì‘ë‹µ âœ…", response);

      if (!response.ok) {
        throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
      }

      alert("ë“±ë¡ ì™„ë£Œ! í™ˆ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
      window.location.href = "../3_home/home.html";

    } catch (error) {
      console.error("ì„œë²„ ì—°ê²° ì‹¤íŒ¨ âŒ", error);
      alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”!");
    }
  });
</script>


</body>
</html>
